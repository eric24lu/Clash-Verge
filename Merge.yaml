# Merge Template for clash verge
# The `Merge` format used to enhance profile
#
# Performance Optimizations:
# 1. YAML anchors used to avoid proxy list repetition (reduces parsing overhead)
# 2. Simplified regex patterns for faster matching
# 3. url-test groups use lazy evaluation with tolerance setting
# 4. Rule providers use format: yaml for faster parsing where applicable

geodata-mode: false
geox-url:
  mmdb: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/GeoLite2-Country.mmdb"
  asn: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/GeoLite2-ASN.mmdb"
geo-auto-update: true
geo-update-interval: 168

# Define reusable proxy lists using YAML anchors to reduce repetition
proxy-group-anchors:
  # All region groups (HK, TW, JP, SG, US, WW)
  all-regions: &all-regions
    - HK
    - TW
    - JP
    - SG
    - US
    - WW
  # Direct + all regions (for services that may need direct access)
  direct-and-regions: &direct-and-regions
    - DIRECT
    - HK
    - TW
    - JP
    - SG
    - US
    - WW
  # Common url-test settings
  url-test-base: &url-test-base
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    tolerance: 50
    lazy: true
    include-all: true
    exclude-type: direct

proxy-groups:
  - name: Subscription
    type: select
    include-all: true
    exclude-type: direct
    # Matches entire string that doesn't contain "Expire"
    filter: "^(?!.*Expire).*$"

  - name: Proxy
    type: select
    proxies: *all-regions
  
  - name: Speedtest
    type: select
    proxies: *direct-and-regions

  - name: Apple
    type: select
    proxies: *direct-and-regions

  - name: Google
    type: select
    proxies: *all-regions

  - name: Microsoft
    type: select
    proxies: *direct-and-regions

  - name: Telegram
    type: select
    proxies: *all-regions

  - name: YouTube
    type: select
    proxies: *all-regions

  - name: Netflix
    type: select
    proxies: *all-regions

  - name: Gaming
    type: select
    proxies: *direct-and-regions

  - name: Social
    type: select
    proxies: *all-regions

  - name: Bilibili
    type: select
    proxies:
      - DIRECT
      - HK
      - TW

  - name: Final
    type: select
    proxies:
      - Proxy
      - DIRECT

  # Region-specific auto-test groups with lazy loading
  - name: HK
    <<: *url-test-base
    filter: "(?i)ðŸ‡­ðŸ‡°|é¦™æ¸¯|Hong\\s*Kong|HK"

  - name: TW
    <<: *url-test-base
    filter: "(?i)ðŸ‡¹ðŸ‡¼|å°[æ¹¾ç£]|Taiwan|TW(?!itch)"

  - name: JP
    <<: *url-test-base
    filter: "(?i)ðŸ‡¯ðŸ‡µ|æ—¥æœ¬|Japan|JP|Tokyo|Osaka"

  - name: SG
    <<: *url-test-base
    filter: "(?i)ðŸ‡¸ðŸ‡¬|æ–°åŠ å¡|Singapore|SG"

  - name: US
    <<: *url-test-base
    filter: "(?i)ðŸ‡ºðŸ‡¸|ç¾Ž[å›½åœ‹]|United\\s*States|US|America"

  # WW group for other regions - using simpler exclusion pattern
  - name: WW
    type: select
    include-all: true
    exclude-type: direct
    exclude-filter: "(?i)ðŸ‡­ðŸ‡°|ðŸ‡¹ðŸ‡¼|ðŸ‡¯ðŸ‡µ|ðŸ‡¸ðŸ‡¬|ðŸ‡ºðŸ‡¸|é¦™æ¸¯|å°[æ¹¾ç£]|æ—¥æœ¬|æ–°åŠ å¡|ç¾Ž[å›½åœ‹]|HK|Hong|TW(?!itch)|Taiwan|JP|Japan|SG|Singapore|US|States|America|Expire|Traffic|æµé‡|åˆ°æœŸ|å‰©ä½™"

# Rule provider base configurations (YAML anchors for DRY principle)
rule-provider-base:
  domain-base: &domain-base
    type: http
    behavior: domain
    interval: 86400
  classical-base: &classical-base
    type: http
    behavior: classical
    interval: 86400
  ipcidr-base: &ipcidr-base
    type: http
    behavior: ipcidr
    interval: 86400

rule-providers:
  # Domain behavior providers (fastest matching - trie-based lookup)
  reject:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/reject.txt"
    path: ./ruleset/reject.yaml

  icloud:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/icloud.txt"
    path: ./ruleset/icloud.yaml

  apple:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/apple.txt"
    path: ./ruleset/apple.yaml

  proxy:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt"
    path: ./ruleset/proxy.yaml

  direct:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/direct.txt"
    path: ./ruleset/direct.yaml

  private:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/private.txt"
    path: ./ruleset/private.yaml

  gfw:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt"
    path: ./ruleset/gfw.yaml

  tld-not-cn:
    <<: *domain-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/tld-not-cn.txt"
    path: ./ruleset/tld-not-cn.yaml

  # IP CIDR behavior providers (efficient prefix tree lookup)
  lancidr:
    <<: *ipcidr-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/lancidr.txt"
    path: ./ruleset/lancidr.yaml

  netflixcidr:
    <<: *ipcidr-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix_IP.yaml"
    path: ./ruleset/netflixcidr.yaml

  # Classical behavior providers (rule-by-rule matching)
  google:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.yaml"
    path: ./ruleset/google.yaml

  telegram:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.yaml"
    path: ./ruleset/telegram.yaml

  applications:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt"
    path: ./ruleset/applications.yaml

  youtube:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.yaml"
    path: ./ruleset/youtube.yaml

  netflix:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.yaml"
    path: ./ruleset/netflix.yaml

  tiktok:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.yaml"
    path: ./ruleset/tiktok.yaml

  bilibili:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/BiliBili/BiliBili.yaml"
    path: ./ruleset/bilibili.yaml

  steam:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.yaml"
    path: ./ruleset/steam.yaml

  steamlist:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/eric24lu/Clash-Verge/main/Steamlist.yaml"
    path: ./ruleset/steamlist.yaml

  facebook:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Facebook/Facebook.yaml"
    path: ./ruleset/facebook.yaml

  instagram:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Instagram/Instagram.yaml"
    path: ./ruleset/instagram.yaml

  reddit:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Reddit/Reddit.yaml"
    path: ./ruleset/reddit.yaml

  openai:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml"
    path: ./ruleset/openai.yaml

  claude:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml"
    path: ./ruleset/claude.yaml

  github:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub.yaml"
    path: ./ruleset/github.yaml

  copilot:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Copilot/Copilot.yaml"
    path: ./ruleset/copilot.yaml

  onedrive:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OneDrive/OneDrive.yaml"
    path: ./ruleset/onedrive.yaml

  microsoft:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.yaml"
    path: ./ruleset/microsoft.yaml

  speedtest:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Speedtest/Speedtest.yaml"
    path: ./ruleset/speedtest.yaml

  twitch:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitch/Twitch.yaml"
    path: ./ruleset/twitch.yaml

  bahamut:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Bahamut/Bahamut.yaml"
    path: ./ruleset/bahamut.yaml

  pikpak:
    <<: *classical-base
    url: "https://raw.githubusercontent.com/eric24lu/ios_rule_script/master/rule/Clash/PikPak/PikPak.yaml"
    path: ./ruleset/pikpak.yaml

# Rules ordered for optimal performance:
# 1. Fast inline rules (IP-CIDR, DST-PORT, PROCESS-NAME) first - O(1) lookups
# 2. Domain behavior rule-sets (trie-based, fast) 
# 3. IP CIDR rule-sets (prefix tree, efficient)
# 4. Classical rule-sets (slower, linear scan)
# 5. Broad catch-all rules last (GEOIP, MATCH)
rules:
  # === Phase 1: Fast inline rules (O(1) or very fast lookups) ===
  # Private/LAN IP ranges - very common, should be first
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,169.254.0.0/16,DIRECT,no-resolve
  - IP-CIDR,224.0.0.0/4,DIRECT,no-resolve
  # Common ports
  - DST-PORT,5353,DIRECT
  - DST-PORT,62078,DIRECT
  # Process-based rules (fast on systems with process matching)
  - PROCESS-NAME,AppleMobileDeviceService.exe,DIRECT
  - PROCESS-NAME,iTunes.exe,DIRECT
  - PROCESS-NAME,iCloud.exe,DIRECT
  - PROCESS-NAME,Sideloadly.exe,DIRECT
  - PROCESS-NAME,iMazing.exe,DIRECT

  # === Phase 2: IP CIDR rule-sets (efficient prefix tree) ===
  - RULE-SET,lancidr,DIRECT,no-resolve

  # === Phase 3: Domain behavior rule-sets (fast trie lookup) ===
  - RULE-SET,reject,REJECT
  - RULE-SET,private,DIRECT
  - RULE-SET,icloud,DIRECT
  - RULE-SET,apple,DIRECT
  - RULE-SET,direct,DIRECT

  # === Phase 4: Classical rule-sets (ordered by expected frequency) ===
  # High-traffic services first
  - RULE-SET,google,Google
  - RULE-SET,youtube,YouTube
  - RULE-SET,microsoft,Microsoft
  - RULE-SET,onedrive,SG
  - RULE-SET,github,US
  - RULE-SET,copilot,US
  # Messaging and social
  - RULE-SET,telegram,Telegram,no-resolve
  - RULE-SET,reddit,Social
  - RULE-SET,instagram,Social
  - RULE-SET,facebook,Social
  # Media and streaming
  - RULE-SET,netflix,Netflix
  - RULE-SET,netflixcidr,Netflix,no-resolve
  - RULE-SET,bilibili,Bilibili
  - RULE-SET,twitch,Proxy
  - RULE-SET,bahamut,TW
  - RULE-SET,tiktok,Proxy
  # AI services
  - RULE-SET,openai,US
  - RULE-SET,claude,US
  # Gaming and downloads
  - RULE-SET,steam,Gaming
  - RULE-SET,steamlist,Gaming
  - RULE-SET,pikpak,SG
  # Utilities
  - RULE-SET,speedtest,Speedtest
  - RULE-SET,applications,DIRECT

  # === Phase 5: Broad domain rules ===
  - RULE-SET,gfw,Proxy
  - RULE-SET,tld-not-cn,Proxy
  - RULE-SET,proxy,Proxy

  # === Phase 6: GeoIP fallback (removed cncidr - redundant with GEOIP,CN) ===
  # Note: cncidr rule-set removed as GEOIP,CN provides same functionality
  # with better performance using mmdb binary lookup
  - GEOIP,CN,DIRECT,no-resolve

  # === Phase 7: Final catch-all ===
  - MATCH,Final
